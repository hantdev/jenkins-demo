pipeline {
  agent any

  environment {
    REGISTRY_URL = credentials('nexus-registry-url')
    REGISTRY_CREDS = credentials('nexus-docker-creds')
    IMAGE_NAME = 'jenkins-demo-app'
    IMAGE_TAG = "${env.BUILD_NUMBER}"
  }

  options {
    timestamps()
    buildDiscarder(logRotator(numToKeepStr: '5'))
    skipDefaultCheckout()
  }

  stages {
    stage('Checkout') {
      steps {
        script {
          sh '''
            echo "=== CHECKOUT STAGE ==="
            echo "Current directory: $(pwd)"
            
            # Clean and initialize git repository
            if [ -d .git ] && ! git status >/dev/null 2>&1; then
              echo "Removing corrupted git repository..."
              rm -rf .git
            fi
            
            if [ ! -d .git ]; then
              echo "Initializing git repository..."
              git init
              git config --global --add safe.directory /var/jenkins_home/workspace/jenkins-demo-pipeline
              git remote add origin https://github.com/hantdev/jenkins-demo.git
            fi
            
            echo "Fetching and checking out code..."
            git fetch origin main
            git checkout -f main
            git reset --hard origin/main
            
            echo "Git status:"
            git status
            echo "Files in workspace:"
            ls -la
          '''
        }
      }
    }

    stage('Build with Kaniko (No Docker Daemon)') {
      steps {
        sh '''
          echo "=== KANIKO BUILD (NO DOCKER DAEMON) ==="
          echo "Registry URL: ${REGISTRY_URL}"
          echo "Image Name: ${IMAGE_NAME}"
          echo "Image Tag: ${IMAGE_TAG}"
          
          # Create Docker config for authentication
          echo "Creating Docker authentication config..."
          mkdir -p /tmp/.docker
          
          cat > /tmp/.docker/config.json << EOF
{
  "auths": {
    "${REGISTRY_URL}": {
      "auth": "$(echo -n "${REGISTRY_CREDS_USR}:${REGISTRY_CREDS_PSW}" | base64)"
    }
  }
}
EOF
          
          echo "Docker config created successfully"
          echo "Config content:"
          cat /tmp/.docker/config.json
          
          # Test registry connectivity
          echo "Testing registry connectivity..."
          curl -I ${REGISTRY_URL}/v2/ || echo "Registry connectivity test completed"
          
          # Download Kaniko binary directly (no Docker daemon needed)
          echo "Downloading Kaniko binary..."
          KANIKO_VERSION="1.9.1"
          
          # Download with retry and proper headers
          for i in {1..3}; do
            echo "Download attempt $i..."
            if curl -L -H "Accept: application/octet-stream" \
               "https://github.com/GoogleContainerTools/kaniko/releases/download/v${KANIKO_VERSION}/kaniko-linux-amd64.tar.gz" \
               -o kaniko.tar.gz; then
              echo "Download successful"
              break
            else
              echo "Download failed, retrying..."
              rm -f kaniko.tar.gz
              sleep 2
            fi
          done
          
          # Verify download
          if [ ! -f kaniko.tar.gz ] || [ $(stat -c%s kaniko.tar.gz) -lt 1000000 ]; then
            echo "ERROR: Kaniko download failed or file too small"
            echo "Trying alternative download method..."
            wget -O kaniko.tar.gz "https://github.com/GoogleContainerTools/kaniko/releases/download/v${KANIKO_VERSION}/kaniko-linux-amd64.tar.gz" || echo "Wget also failed"
          fi
          
          # Extract with verification
          echo "Extracting Kaniko binary..."
          tar -xzf kaniko.tar.gz || echo "Tar extraction failed, trying gzip first"
          chmod +x kaniko-linux-amd64/executor
          
          # Build and push with Kaniko binary
          echo "Starting Kaniko build and push (no Docker daemon)..."
          echo "This may take a few minutes..."
          
          ./kaniko-linux-amd64/executor \
            --context=/var/jenkins_home/workspace/jenkins-demo-pipeline \
            --dockerfile=/var/jenkins_home/workspace/jenkins-demo-pipeline/Dockerfile \
            --destination=${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG} \
            --destination=${REGISTRY_URL}/${IMAGE_NAME}:latest \
            --verbosity=debug
          
          echo "=== KANIKO BUILD COMPLETED SUCCESSFULLY ==="
          echo "Images pushed to registry:"
          echo "  - ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}"
          echo "  - ${REGISTRY_URL}/${IMAGE_NAME}:latest"
          echo "=== END OF PIPELINE ==="
        '''
      }
    }
  }
}
